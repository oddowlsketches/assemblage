<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Loading Test</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
            font-family: Arial, sans-serif;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }
        .image-item {
            position: relative;
            background: #333;
            border-radius: 4px;
            overflow: hidden;
            aspect-ratio: 1;
        }
        .image-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .image-item .status {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            padding: 4px;
            font-size: 12px;
            text-align: center;
        }
        .controls {
            margin: 20px 0;
            padding: 20px;
            background: #2a2a2a;
            border-radius: 8px;
        }
        button {
            padding: 10px 20px;
            background: #4a4a4a;
            border: none;
            color: #fff;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s;
        }
        button:hover {
            background: #5a5a5a;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Image Loading Test</h1>
        
        <div class="controls">
            <button id="loadBtn">Load Images</button>
            <button id="testBtn">Test Crystal Generation</button>
        </div>
        
        <div id="imageGrid" class="image-grid"></div>
    </div>

    <script type="module">
        import { loadImageCollection } from './js/data.js';
        import CollageGenerator from './js/collage/collageGenerator.js';
        
        // Create a canvas for testing
        const canvas = document.createElement('canvas');
        canvas.width = 800;
        canvas.height = 600;
        document.body.appendChild(canvas);
        
        // Initialize collage generator
        const collageGenerator = new CollageGenerator(canvas);
        
        // Load images
        let imageCollection = [];
        
        document.getElementById('loadBtn').addEventListener('click', async () => {
            try {
                // Get the image collection
                const imageData = await loadImageCollection();
                console.log('Loaded image data:', imageData.length, 'items');
                
                // Create actual HTMLImageElement objects
                const imageElements = imageData.map(imgData => {
                    const img = new Image();
                    img.src = imgData.src;
                    return img;
                });
                
                // Create a loading indicator
                const loadingIndicator = document.createElement('div');
                loadingIndicator.id = 'loadingIndicator';
                loadingIndicator.style.position = 'fixed';
                loadingIndicator.style.top = '50%';
                loadingIndicator.style.left = '50%';
                loadingIndicator.style.transform = 'translate(-50%, -50%)';
                loadingIndicator.style.padding = '20px';
                loadingIndicator.style.background = 'rgba(0, 0, 0, 0.7)';
                loadingIndicator.style.borderRadius = '10px';
                loadingIndicator.style.zIndex = '1000';
                loadingIndicator.textContent = 'Loading images...';
                document.body.appendChild(loadingIndicator);
                
                // Ensure all images are loaded before proceeding
                const imagePromises = imageElements.map(img => {
                    return new Promise((resolve) => {
                        // If the image is already loaded, resolve immediately
                        if (img.complete && img.naturalWidth > 0) {
                            console.log('Image already loaded:', img.src);
                            resolve(img);
                        } else {
                            // Set up load and error handlers
                            img.onload = () => {
                                console.log('Image loaded:', img.src);
                                resolve(img);
                            };
                            img.onerror = () => {
                                console.error('Failed to load image:', img.src);
                                resolve(null);
                            };
                        }
                    });
                });
                
                // Update loading indicator
                let loadedCount = 0;
                const updateLoadingIndicator = () => {
                    loadedCount++;
                    const percent = Math.round((loadedCount / imageElements.length) * 100);
                    loadingIndicator.textContent = `Loading images... ${percent}%`;
                };
                
                // Wait for all images to load with progress updates
                const loadedImages = await Promise.all(
                    imagePromises.map(promise => 
                        promise.then(img => {
                            updateLoadingIndicator();
                            return img;
                        })
                    )
                );
                
                // Filter out any failed loads
                imageCollection = loadedImages.filter(img => img !== null);
                console.log('Successfully loaded', imageCollection.length, 'images');
                
                // Remove loading indicator
                document.body.removeChild(loadingIndicator);
                
                // Display the first 20 images
                const imageGrid = document.getElementById('imageGrid');
                imageGrid.innerHTML = '';
                
                imageCollection.slice(0, 20).forEach((img, index) => {
                    const imageItem = document.createElement('div');
                    imageItem.className = 'image-item';
                    
                    const imgElement = document.createElement('img');
                    imgElement.src = img.src;
                    imageItem.appendChild(imgElement);
                    
                    const status = document.createElement('div');
                    status.className = 'status';
                    status.textContent = `Image ${index + 1}: ${img.complete ? 'Loaded' : 'Loading'} (${img.naturalWidth}x${img.naturalHeight})`;
                    imageItem.appendChild(status);
                    
                    imageGrid.appendChild(imageItem);
                });
                
                // Enable the test button
                document.getElementById('testBtn').disabled = false;
            } catch (error) {
                console.error('Error loading images:', error);
                alert('Error loading images: ' + error.message);
            }
        });
        
        // Test crystal generation
        document.getElementById('testBtn').addEventListener('click', async () => {
            if (imageCollection.length === 0) {
                alert('Please load images first');
                return;
            }
            
            try {
                const parameters = {
                    isolatedMode: true,
                    template: 'hexagonal',
                    crystalComplexity: 5,
                    crystalDensity: 5,
                    crystalOpacity: 0.7,
                    addGlow: true
                };
                
                await collageGenerator.generateCrystal(imageCollection, null, parameters);
                console.log('Crystal generation completed');
            } catch (error) {
                console.error('Error generating crystal:', error);
                alert('Error generating crystal: ' + error.message);
            }
        });
        
        // Disable the test button initially
        document.getElementById('testBtn').disabled = true;
    </script>
</body>
</html> 